# -*- coding: utf-8 -*-
"""debug_gpt.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1gj7iG9R0bTB94YZ5BuIfJJ43blTgfEOh
"""

# !pip install openai

import openai
import pandas as pd
from openai import OpenAI
from tqdm import tqdm
# import ssl
# ssl._create_default_https_context = ssl._create_stdlib_context

# Load  dataset
# data = pd.read_csv('/content/example_plausible_gallstones.csv')#.head(1)
data = pd.read_csv('./Reports/example_plausible_gallstones.csv')#.head(1)

# Set up your OpenAI API key
# openai.api_key = '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'
openai.api_key = "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"

global client
client = OpenAI(
    # defaults to os.environ.get("OPENAI_API_KEY")
    api_key = openai.api_key 
)

## 
icl_examples = [
{'role': 'user',
  'content': "Given the feature 'Long-standing illness, disability or infirmity Yes'; (p-value: 0.0, correlation: 0.049, SHAP importance 0.041), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant', 'content': 'Yes. CVD risk factors'},
 {'role': 'user',
  'content': "Given the feature 'Long-standing illness, disability or infirmity Yes'; (p-value: 0.0, correlation: 0.049, SHAP importance 0.041), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant', 'content': 'Yes. CVD risk factors'},
 {'role': 'user',
  'content': "Given the feature 'Alanine aminotransferase'; (p-value: 0.0, correlation: 0.027, SHAP importance 0.032), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant', 'content': 'No. liver enzyme'},
 {'role': 'user',
  'content': "Given the feature 'Alanine aminotransferase'; (p-value: 0.0, correlation: 0.027, SHAP importance 0.032), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant', 'content': 'Yes. liver enzyme'},
 {'role': 'user',
  'content': "Given the feature 'Mouth/teeth dental problems Dentures'; (p-value: 0.0, correlation: 0.031, SHAP importance 0.023), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant', 'content': 'Yes. nutrition'},
 {'role': 'user',
  'content': "Given the feature 'Mouth/teeth dental problems Dentures'; (p-value: 0.0, correlation: 0.031, SHAP importance 0.023), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant', 'content': 'Yes. nutrition'},
 {'role': 'user',
  'content': "Given the feature 'Overall health rating Excellent'; (p-value: 0.0, correlation: -0.042, SHAP importance 0.011), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant', 'content': 'Yes. healthy life style'},
 {'role': 'user',
  'content': "Given the feature 'Overall health rating Excellent'; (p-value: 0.0, correlation: -0.042, SHAP importance 0.011), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant', 'content': 'Yes. healthy life style'},
 {'role': 'user',
  'content': "Given the feature 'Haemoglobin concentration'; (p-value: 0.0, correlation: -0.014, SHAP importance 0.01), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant', 'content': 'No. M<>F'},
 {'role': 'user',
  'content': "Given the feature 'Haemoglobin concentration'; (p-value: 0.0, correlation: -0.014, SHAP importance 0.01), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant', 'content': 'Yes. M<>F'},
 {'role': 'user',
  'content': "Given the feature 'SHBG'; (p-value: 0.0, correlation: -0.006, SHAP importance 0.01), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant', 'content': 'No. M<>F'},
 {'role': 'user',
  'content': "Given the feature 'SHBG'; (p-value: 0.0, correlation: -0.006, SHAP importance 0.01), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant', 'content': 'Yes. M<>F'},
 {'role': 'user',
  'content': "Given the feature 'Standing height'; (p-value: 0.0, correlation: -0.041, SHAP importance 0.009), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant', 'content': 'No. M<>F'},
 {'role': 'user',
  'content': "Given the feature 'Standing height'; (p-value: 0.0, correlation: -0.041, SHAP importance 0.009), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant', 'content': 'Yes. M<>F'},
 {'role': 'user',
  'content': "Given the feature 'Gastritis and duodenitis'; (p-value: 0.0, correlation: 0.013, SHAP importance 0.009), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant', 'content': 'Yes. life style'},
 {'role': 'user',
  'content': "Given the feature 'Gastritis and duodenitis'; (p-value: 0.0, correlation: 0.013, SHAP importance 0.009), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant', 'content': 'Yes. life style'},
 {'role': 'user',
  'content': "Given the feature 'Standard PRS for venous thromboembolic disease (VTE)'; (p-value: 0.002, correlation: 0.007, SHAP importance 0.008), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant', 'content': 'No. Obesity and lifesytle'},
 {'role': 'user',
  'content': "Given the feature 'Standard PRS for venous thromboembolic disease (VTE)'; (p-value: 0.002, correlation: 0.007, SHAP importance 0.008), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant', 'content': 'Yes. Obesity and lifesytle'},
 {'role': 'user',
  'content': "Given the feature 'Townsend deprivation index at recruitment'; (p-value: 0.0, correlation: 0.024, SHAP importance 0.006), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant', 'content': 'Yes. important'},
 {'role': 'user',
  'content': "Given the feature 'Townsend deprivation index at recruitment'; (p-value: 0.0, correlation: 0.024, SHAP importance 0.006), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant', 'content': 'Yes. important'},
 {'role': 'user',
  'content': "Given the feature 'Contra-indications for spirometry'; (p-value: 0.0, correlation: -0.005, SHAP importance 0.003), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant',
  'content': 'No. Probably, irrelevant - it is not avery useful feature in the clinic - it is probably related throught other features. (it usually means that the person has a significant disease burden (the C?I are: Absolute Contraindications\nHemodynamic instability.\nRecent myocardial infarction or acute coronary syndrome.\nRespiratory infection, a recent pneumothorax, or a pulmonary embolism.\nA growing or large (>6 cm) aneurysm of the thoracic, abdominal aorta.\nHemoptysis of acute onset.\nIntracranial hypertension.\nRetinal detachment)'},
 {'role': 'user',
  'content': "Given the feature 'Contra-indications for spirometry'; (p-value: 0.0, correlation: -0.005, SHAP importance 0.003), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant',
  'content': 'No. Probably, irrelevant - it is not avery useful feature in the clinic - it is probably related throught other features. (it usually means that the person has a significant disease burden (the C?I are: Absolute Contraindications\nHemodynamic instability.\nRecent myocardial infarction or acute coronary syndrome.\nRespiratory infection, a recent pneumothorax, or a pulmonary embolism.\nA growing or large (>6 cm) aneurysm of the thoracic, abdominal aorta.\nHemoptysis of acute onset.\nIntracranial hypertension.\nRetinal detachment)'},
 {'role': 'user',
  'content': "Given the feature 'Salt added to food Never/rarely'; (p-value: 0.0, correlation: 0.012, SHAP importance 0.003), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant',
  'content': "Yes. I'm not sure that this feature represent food prefencese it may be related to a prescribes. medical diet of kidney or heart failure"},
 {'role': 'user',
  'content': "Given the feature 'Salt added to food Never/rarely'; (p-value: 0.0, correlation: 0.012, SHAP importance 0.003), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant',
  'content': "Yes. I'm not sure that this feature represent food prefencese it may be related to a prescribes. medical diet of kidney or heart failure"},
 {'role': 'user',
  'content': "Given the feature 'Year immigrated to UK (United Kingdom)'; (p-value: 0.0, correlation: -0.005, SHAP importance 0.003), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant',
  'content': 'No. more inforamation is needed to under stand if these reflect a diffrent diet, or just age/ wave of immigration etc.'},
 {'role': 'user',
  'content': "Given the feature 'Year immigrated to UK (United Kingdom)'; (p-value: 0.0, correlation: -0.005, SHAP importance 0.003), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant',
  'content': 'No. more inforamation is needed to under stand if these reflect a diffrent diet, or just age/ wave of immigration etc.'},
 {'role': 'user',
  'content': "Given the feature 'Neuroticism score'; (p-value: 0.902, correlation: -0.007, SHAP importance 0.003), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant',
  'content': "No. The p-value is very high, so I'm nor sure if it is truly relevant"},
 {'role': 'user',
  'content': "Given the feature 'Neuroticism score'; (p-value: 0.902, correlation: -0.007, SHAP importance 0.003), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant',
  'content': "No. The p-value is very high, so I'm nor sure if it is truly relevant"},
 {'role': 'user',
  'content': "Given the feature 'dietary changes in the last 5 years Yes, because of other reasons'; (p-value: 0.0, correlation: 0.003, SHAP importance 0.003), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant',
  'content': 'No. change of diet can be post cholelthiasis diagnosis'},
 {'role': 'user',
  'content': "Given the feature 'dietary changes in the last 5 years Yes, because of other reasons'; (p-value: 0.0, correlation: 0.003, SHAP importance 0.003), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant',
  'content': 'Yes. change of diet can be post cholelthiasis diagnosis'},
 {'role': 'user',
  'content': "Given the feature 'Variation in diet Never/rarely'; (p-value: 0.0, correlation: -0.004, SHAP importance 0.002), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant', 'content': 'No. Normal BMI, asymptomatic person'},
 {'role': 'user',
  'content': "Given the feature 'Variation in diet Never/rarely'; (p-value: 0.0, correlation: -0.004, SHAP importance 0.002), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant', 'content': 'Yes. Normal BMI, asymptomatic person'},
 {'role': 'user',
  'content': "Given the feature 'Wheeze or whistling in the chest in last year'; (p-value: 0.0, correlation: 0.004, SHAP importance 0.002), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant',
  'content': 'Yes. person more sick in general? more imagery studies leading to higher incidental diagnoses rate?'},
 {'role': 'user',
  'content': "Given the feature 'Wheeze or whistling in the chest in last year'; (p-value: 0.0, correlation: 0.004, SHAP importance 0.002), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant',
  'content': 'Yes. person more sick in general? more imagery studies leading to higher incidental diagnoses rate?'},
 {'role': 'user',
  'content': "Given the feature 'Alcohol intake frequency. Daily or almost daily'; (p-value: 0.0, correlation: -0.006, SHAP importance 0.044), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant',
  'content': 'Yes. inline with  https://pubmed.ncbi.nlm.nih.gov/27926662/      . A linear dose-response relationship was found between alcohol consumption and gallstone disease risk and the risk of gallstone disease decreased by 12% (RR=0.88, 95% CI: 0.84-0.92; Pnonlinearity=0.079) for each 10 g/day increment in alcohol consumption. This meta-analysis suggests that alcohol consumption is associated with significantly decreased risk of gallstone disease.'},
 {'role': 'user',
  'content': "Given the feature 'Alcohol intake frequency. Daily or almost daily'; (p-value: 0.0, correlation: -0.006, SHAP importance 0.044), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant',
  'content': 'Yes. inline with  https://pubmed.ncbi.nlm.nih.gov/27926662/      . A linear dose-response relationship was found between alcohol consumption and gallstone disease risk and the risk of gallstone disease decreased by 12% (RR=0.88, 95% CI: 0.84-0.92; Pnonlinearity=0.079) for each 10 g/day increment in alcohol consumption. This meta-analysis suggests that alcohol consumption is associated with significantly decreased risk of gallstone disease.'},
 {'role': 'user',
  'content': "Given the feature 'Alcohol intake frequency. Special occasions only'; (p-value: 0.0, correlation: 0.002, SHAP importance 0.014), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant',
  'content': 'Yes. inline with  https://pubmed.ncbi.nlm.nih.gov/27926662/      . A linear dose-response relationship was found between alcohol consumption and gallstone disease risk and the risk of gallstone disease decreased by 12% (RR=0.88, 95% CI: 0.84-0.92; Pnonlinearity=0.079) for each 10 g/day increment in alcohol consumption. This meta-analysis suggests that alcohol consumption is associated with significantly decreased risk of gallstone disease.'},
 {'role': 'user',
  'content': "Given the feature 'Alcohol intake frequency. Special occasions only'; (p-value: 0.0, correlation: 0.002, SHAP importance 0.014), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant',
  'content': 'Yes. inline with  https://pubmed.ncbi.nlm.nih.gov/27926662/      . A linear dose-response relationship was found between alcohol consumption and gallstone disease risk and the risk of gallstone disease decreased by 12% (RR=0.88, 95% CI: 0.84-0.92; Pnonlinearity=0.079) for each 10 g/day increment in alcohol consumption. This meta-analysis suggests that alcohol consumption is associated with significantly decreased risk of gallstone disease.'},
 {'role': 'user',
  'content': "Given the feature 'Time spend outdoors in summer'; (p-value: 0.0, correlation: 0.007, SHAP importance 0.003), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant', 'content': 'Yes. May reflect more physical activity'},
 {'role': 'user',
  'content': "Given the feature 'Time spend outdoors in summer'; (p-value: 0.0, correlation: 0.007, SHAP importance 0.003), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant', 'content': 'Yes. May reflect more physical activity'},
 {'role': 'user',
  'content': "Given the feature 'Z92.2 - Personal history of long-term (current) use of other medicaments'; (p-value: 0.816, correlation: 0.001, SHAP importance 0.003), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant',
  'content': 'No. Sicker people - more sick?/more imagery studies?'},
 {'role': 'user',
  'content': "Given the feature 'Z92.2 - Personal history of long-term (current) use of other medicaments'; (p-value: 0.816, correlation: 0.001, SHAP importance 0.003), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant',
  'content': 'No. Sicker people - more sick?/more imagery studies?'},
 {'role': 'user',
  'content': "Given the feature 'Apolipoprotein A1'; (p-value: 0.0, correlation: 0.006, SHAP importance 0.01), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant',
  'content': 'Yes. https://www.sciencedirect.com/science/article/pii/S002368372202339X'},
 {'role': 'user',
  'content': "Given the feature 'Apolipoprotein A1'; (p-value: 0.0, correlation: 0.006, SHAP importance 0.01), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant',
  'content': 'No. https://www.sciencedirect.com/science/article/pii/S002368372202339X'},
 {'role': 'user',
  'content': "Given the feature 'Frequency of friend/family visits Almost daily'; (p-value: 0.0, correlation: 0.001, SHAP importance 0.004), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant', 'content': 'Yes. more active, less sick'},
 {'role': 'user',
  'content': "Given the feature 'Frequency of friend/family visits Almost daily'; (p-value: 0.0, correlation: 0.001, SHAP importance 0.004), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant', 'content': 'Yes. more active, less sick'},
 {'role': 'user',
  'content': "Given the feature 'Testosterone'; (p-value: 0.0, correlation: -0.005, SHAP importance 0.007), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant', 'content': 'Yes. Women have more'},
 {'role': 'user',
  'content': "Given the feature 'Testosterone'; (p-value: 0.0, correlation: -0.005, SHAP importance 0.007), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant', 'content': 'Yes. Women have more'},
 {'role': 'user',
  'content': "Given the feature 'Genetic risk for bipolar disorder'; (p-value: 0.037, correlation: -0.004, SHAP importance 0.006), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant', 'content': 'Yes. less imagery?'},
 {'role': 'user',
  'content': "Given the feature 'Genetic risk for bipolar disorder'; (p-value: 0.037, correlation: -0.004, SHAP importance 0.006), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant', 'content': 'Yes. less imagery?'},
 {'role': 'user',
  'content': "Given the feature 'Enhanced Genetic risk for height (HEIGHT)'; (p-value: 0.931, correlation: 0.004, SHAP importance 0.003), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant',
  'content': 'No. similar to row 65 - feature used twice, by mistake'},
 {'role': 'user',
  'content': "Given the feature 'Enhanced Genetic risk for height (HEIGHT)'; (p-value: 0.931, correlation: 0.004, SHAP importance 0.003), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant',
  'content': 'No. similar to row 65 - feature used twice, by mistake'},
 {'role': 'user',
  'content': "Given the feature 'Microalbumin in urine'; (p-value: 0.123, correlation: 0.009, SHAP importance 0.003), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant',
  'content': 'Yes. related to diabetes, HTN, metabolic syndrome,  relativly high P-value'},
 {'role': 'user',
  'content': "Given the feature 'Microalbumin in urine'; (p-value: 0.123, correlation: 0.009, SHAP importance 0.003), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant',
  'content': 'Yes. related to diabetes, HTN, metabolic syndrome,  relativly high P-value'},
 {'role': 'user',
  'content': "Given the feature 'Alcohol-related disorders'; (p-value: 0.051, correlation: 0.001, SHAP importance 0.002), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant',
  'content': 'Yes. oppsite to https://pubmed.ncbi.nlm.nih.gov/27926662/'},
 {'role': 'user',
  'content': "Given the feature 'Alcohol-related disorders'; (p-value: 0.051, correlation: 0.001, SHAP importance 0.002), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant',
  'content': 'No. oppsite to https://pubmed.ncbi.nlm.nih.gov/27926662/'},
 {'role': 'user',
  'content': "Given the feature 'Alcohol intake frequency. Never'; (p-value: 0.0, correlation: -0.002, SHAP importance 0.002), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant',
  'content': 'Yes. oppsite to https://pubmed.ncbi.nlm.nih.gov/27926662/'},
 {'role': 'user',
  'content': "Given the feature 'Alcohol intake frequency. Never'; (p-value: 0.0, correlation: -0.002, SHAP importance 0.002), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant',
  'content': 'No. oppsite to https://pubmed.ncbi.nlm.nih.gov/27926662/'},
 {'role': 'user',
  'content': "Given the feature 'Circulatory disease NEC'; (p-value: 0.523, correlation: 0.008, SHAP importance 0.001), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant', 'content': 'Yes. related to metabolic synmdrome'},
 {'role': 'user',
  'content': "Given the feature 'Circulatory disease NEC'; (p-value: 0.523, correlation: 0.008, SHAP importance 0.001), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant', 'content': 'Yes. related to metabolic synmdrome'},
 {'role': 'user',
  'content': "Given the feature 'Cholesterol in Chylomicrons and Extremely Large VLDL'; (p-value: 0.0, correlation: 0.002, SHAP importance 0.001), as a potential predictive feature, or risk/protective factor for target disease: 'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."},
 {'role': 'assistant',
  'content': 'Yes. - Our meta-analysis found insufficient evidence for the effect of APOE E4 on GSD risk.'},
 {'role': 'user',
  'content': "Given the feature 'Cholesterol in Chylomicrons and Extremely Large VLDL'; (p-value: 0.0, correlation: 0.002, SHAP importance 0.001), as a potential predictive feature, or risk/protective factor for target disease:'Cholelithiasis OR Gallstones OR Gallbladder disease OR cholecystitis OR Cholangitis', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain for a medical expert."},
 {'role': 'assistant',
  'content': 'No. - Our meta-analysis found insufficient evidence for the effect of APOE E4 on GSD risk.'}]



# In[4]:


def query_gpt(prompt):
    """Function to query GPT-4 model and return the response, with error handling."""
    try:
        response = client.chat.completions.create(
            model= "gpt-4o-mini" #"gpt-4"#"gpt-4o-mini",
            ,messages=[
                {"role": "system", "content": "You are a helpful scientific researcher. You are critical and grounded in scientific evidence, while being open to new connections and novel leaps. You research, understand, filter and validate (or disprove) candidate novel discoveries and features for research"},
                *icl_examples,
                {"role": "user", "content": prompt}
            ],
            max_tokens=256,
            temperature=0.75,
            stop=None
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        print(f"An error occurred: {e}")
        return "Error in generating response."

# Process each row in the dataset
results = []
for index, row in tqdm(data.iterrows(), total=data.shape[0], desc="Processing rows"):
    feature_name = row['feature_name']
    target = row['Target'].replace(r"\(\)","").replace(" AND "," ").replace("(","").replace(")","")
    p_val = row['p_val']
    feature_importance = row['feature_importance']
    correlation = row['correlation']

    # prompt_interesting = f"Given the feature '{feature_name}'; (p-value: {p_val}, correlation: {correlation}, SHAP importance {feature_importance}), as a potential predictor, risk/protective factor, interaction or predictive feature for target disease: '{target}', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."
    # prompt_plausible = f"Given the feature '{feature_name}'; (p-value: {p_val}, correlation: {correlation}, SHAP importance {feature_importance}), as a potential predictor, risk/protective factor, interaction or predictive feature for target disease: '{target}', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain why for a medical expert."
    prompt_interesting = f"Given the feature '{feature_name}'; (p-value: {p_val}, correlation: {correlation}, SHAP importance {feature_importance}), as a potential predictor, risk/protective factor, interaction or predictive feature for target disease: '{target}', is this feature interesting and Novel? Predict 'Yes.' or 'No.', then explain why for a medical expert."
    prompt_plausible = f"Given the feature '{feature_name}'; (p-value: {p_val}, correlation: {correlation}, SHAP importance {feature_importance}), as a potential predictor, risk/protective factor, interaction or predictive feature for target disease: '{target}', does this feature make sense? Is there a plausible mechanism for the feature to affect the target disease? Predict 'Yes.' or 'No.', then explain why for a medical expert."

    interesting_response = query_gpt(prompt_interesting)
    plausible_response = query_gpt(prompt_plausible)

    # Handle "Yes", "No", or missing cases
    def extract_response(response):
        lower_response = response.lower()
        if 'yes' in lower_response.split('.')[0].lower():
            return 'Yes'
        elif 'no' in lower_response.split('.')[0].lower():
            return 'No'
        else:
            return 'Missing'

    results.append({
        'Feature': feature_name,
        'Interesting?': extract_response(interesting_response),
        'Explanation (Interesting)': interesting_response,
        'Plausible/Makes Sense?': extract_response(plausible_response),
        'Explanation (Plausible)': plausible_response
    })

# Convert results to DataFrame for better visualization and saving
results_df = pd.DataFrame(results)


# In[5]:


# display(results_df)
print(results_df.shape)
results_df = results_df.loc[results_df['Explanation (Interesting)' ]!= 'Error in generating response.']

print(results_df.shape)
print(results_df.head())
results_df.to_csv('gpt_results_explanations_chol.csv', index=False)

print(results_df['Interesting?'].value_counts())
print(results_df['Plausible/Makes Sense?'].value_counts())